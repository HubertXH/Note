# 系统IO监控指标

- top
- vmstat
- iostat
- iotop
- pt-ioprofile
- pidstat

#### top

````
top - 13:43:42 up 1070 days, 22:27,  1 user,  load average: 2.91, 5.01, 6.93
Tasks: 209 total,   1 running, 208 sleeping,   0 stopped,   0 zombie
%Cpu(s):  3.7 us,  1.1 sy,  0.0 ni, 95.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st
KiB Mem : 32374620 total,   223024 free,  7064456 used, 25087140 buff/cache
KiB Swap: 67071996 total, 65133684 free,  1938312 used. 24497028 avail Mem 

````

- 指标解释：
    - us, user    : nice值为0的用户进程占用CPU时间百分比
    - sy, system  : 系统内核占用CPU的时间百分比
    - ni, nice    : nice不为0的用户进程占用CPU时间百分比
    - id, idle    : CUP空闲时间百分比
    - wa, IO-wait : 等待IO时间
    - hi : 硬中断耗费的时间百分比
    - si : 软中断耗费的时间百分比
    - st : 虚拟机管理程序从此虚拟机窃取的时间

在这里我们主要关注 wa 数值，如果改指标的数值较高则说明有大量的IO占用。

---

#### vmstat

<table>
    <tr>
        <td colspan="2">Procs</td>
        <td colspan="4">Memory</td>
        <td colspan="2">Swap</td>
        <td colspan="2">IO</td>
        <td colspan="2">System</td>
        <td colspan="5">Cpu</td>
    </tr>
    <tr>
        <td>r</td>
        <td>b</td>
        <td>swpd</td>
        <td>free</td>
        <td>buff</td>
        <td>cache</td>
        <td>si</td>
        <td>so</td>
        <td>bi</td>
        <td>bo</td>
        <td>in</td>
        <td>cs</td>
        <td>us</td>
        <td>sy</td>
        <td>id</td>
        <td>wa</td>
        <td>st</td>
    </tr>
    <tr>
        <td>0</td>
        <td>0</td>
        <td>691</td>
        <td>19393</td>
        <td>325</td>
        <td>11282</td>
        <td>0</td>
        <td>0</td>
        <td>1</td>
        <td>35</td>
        <td>0</td>
        <td>0</td>
        <td>3</td>
        <td>1</td>
        <td>96</td>
        <td>0</td>
        <td>0</td>
    </tr>
</table>

- 指标解释
    + Procs
        + r: 列表示运行和等待cpu时间片的进程数，如果长期大于1，说明cpu不足，需要增加cpu，数量越大，系统越繁忙。
        + b: 表示在等待资源的进程数，比如正在等待I/O、或者内存交换等，数量越大，系统越繁忙。

    + Memory
        + swpd: 虚拟内存已使用的大小，如果大于0，或者比较大需要注意系统内存够，如果si、so的值长期为0，系统性能还是正常。
        + free: 当前的空闲页面列表中内存数量。
        + buff: Linux/Unix系统是用来存储，目录里面有什么内容，权限等的缓存。
        + cache: 作为page cache的内存数量，一般作为文件系统的cache，如果cache较大，说明用到cache的文件较多，如果此时IO中bi比较小，说明文件系统效率比较好。
        + inact: 非活动内存的数量。（-a选项）
        + active: 活动内存的数量。（-a选项）

    + Swap
        + si: 每秒从磁盘读入虚拟内存的大小，如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉
        + so: 每秒虚拟内存写入磁盘的大小。如果这个值大于0，表示物理内存不够用或者内存泄露了，要查找耗内存进程解决掉

    + IO
        + bi: 块设备每秒接收的块数量，这里的块设备是指系统上所有的磁盘和其他块设备.
        + bo: 块设备每秒发送的块数量，例如我们读取文件，这里我们设置的bi+bo参考值为1000，如果超过1000，而且wa值较大应该考虑均衡磁盘负载，可以结合iostat输出来分析。

    + System
        + in: 每秒CPU的中断次数，包括时间中断。
        + cs: 每秒上下文切换次数，例如我们调用系统函数，就要进行上下文切换，线程的切换，也要进程上下文切换，这个值要越小越好，太大了，要考虑调低线程或者进程的数目.

    + CPU
        + us: 用户进程占用CPU时间包含nice和非nice进程，us的值比较高时，说明用户进程消耗的cpu时间多，但是如果长期大于50%，需要考虑优化用户的程序。
        + sy: 内核进程所花费的cpu时间的百分比。这里us + sy的参考值为80%，如果us+sy 大于 80%说明可能存在CPU不足。
        + id: 空闲 CPU时间，一般来说，id + us + sy = 100 .
        + wa: 等待IO
          CPU时间。这里wa的参考值为30%，如果wa超过30%，说明IO等待严重，这可能是磁盘大量随机访问造成的，也可能磁盘或者磁盘访问控制器的带宽瓶颈造成的(
          主要是块操作)。
        + st: 虚拟机管理程序从此虚拟机窃取的时间 .

---

#### iostat

| 参数 | 说明            |
|----|---------------|
| -c | 显示CPU使用情况     |
| -d | 显示磁盘使用情况      |
| -k | 已KB为单位显示统计信息  |
| -M | 以MB为单位显示统计信息  |
| -n | 显示NFS使用统计信息   |
| -p | 显示设备块及其分区统计信息 |
| -t | 打印时间          |
| -x | 显示额外统计信息      |

设备利用指标解释

```
Linux 3.10.0-1160.42.2.el7.x86_64 (server2) 	04/25/2023 	_x86_64_	(8 CPU)

Device:         rrqm/s   wrqm/s     r/s     w/s    rkB/s    wkB/s avgrq-sz avgqu-sz   await r_await w_await  svctm  %util
sda               0.00     2.13    0.03    1.12     0.41    23.23    40.87     0.00    0.75    7.23    0.56   0.09   0.01
sda1              0.00     0.00    0.00    0.00     0.01     0.00   151.24     0.00    6.12    6.37    0.92   5.49   0.00
sda2              0.00     0.00    0.00    0.00     0.00     0.00    89.85     0.00   15.35   15.35    0.00  13.40   0.00
sda3              0.00     2.13    0.03    1.12     0.40    23.23    40.85     0.00    0.75    7.23    0.56   0.09   0.01
```

|    | 指标名称      | 说明                                                                                               |
|----|-----------|--------------------------------------------------------------------------------------------------|
| 1  | Device    | 设备名                                                                                              |
| 2  | rrqm/s    | 每秒这个设备相关的读取请求有多少被Merge了（当系统调用需要读取数据的时候，VFS将请求发到各个FS，如果FS发现不同的读取请求读取的是相同Block的数据，FS会将这个请求合并Merge） |
| 3  | wrqm/s    | 每秒这个设备相关的写入请求有多少被Merge了                                                                          |
| 4  | r/s       | 设备块每秒钟的读请求数                                                                                      |
| 5  | w/s       | 设备块每秒钟的写请求数                                                                                      |
| 6  | rkB(MB)/s | 每秒钟从设备块读取的数据大小单位为KB/MB                                                                           | 
| 7  | wkB(MB)/s | 每秒钟向设备块写入的数据大小单位为KB/MB                                                                           |
| 8  | avgrq-sz  | 每个IO请求的请求的扇区数量                                                                                   | 
| 9  | avgqu-sz  | 等待设备块处理的IO请求的等待队列大小（越小越好）                                                                        | 
| 10 | await     | 每一个IO请求的处理时间，包含等待和数据处理                                                                           |
| 11 | svctm     | 平均每个IO请求的数据处理时间-不准确                                                                              |
| 12 | %util     | 处理IO请求的时间占比，此数值越高说明磁盘的负载越高。                                                                      |

补充说明：

- %utils:
  在统计时间内所有处理IO时间除以总共统计时间。例如，如果统计间隔1秒，该设备有0.8秒在处理IO，而0.2秒闲置，那么该设备的%util =
  0.8/1 = 80%，所以该参数暗示了设备的繁忙程度
  。一般地，如果该参数是100%表示设备已经接近满负荷运行了（当然如果是多磁盘，即使%util是100%，因为磁盘的并发能力，所以磁盘使用未必就到了瓶颈）。
- avgrq-sz:统计时间段内平均下来，这段时间内，所有请求的平均大小，单位是扇区，即（512字节）。

常见用法：

- iostat -d 1 5 统计磁盘信息，每秒钟统计一次，共统计5次
- iostat -dxm 2 5 统计磁盘使用信息，每2秒钟统计一次，共统计5次，输出扩展信息，信息输出的单位为MB

#### iotop

| 参数 | 说明                                      |
|----|-----------------------------------------|
| -o | 只展示进行IO的线程或进程（默认展示全部），通过展示页面按o键可以进行动态切换 |
| -b | 打开非交互模式                                 |
| -n | 统计N次后退出                                 |
| -d | 统计周期，即d秒钟统计一次                           |
| -p | 后接PID,监控某一个进程或线程的IO                     |
| -u |                                         |
| -P | 只展示进程（默认展示所有进程和线程）                      |
| -a | 展示积累量而非流量大小                             |
| -k | 以KB为单位展示                                |
| -t | 打印时间                                    |

```
PID | PRIO | USER | DISK READ(读) | DISK WRITE(写) | SWAPIN | IO(IO占比) | COMMAND
914   be/3   root |  0.00 B/s     | 815.33 B/s    | 0.00 % | 0.02 %  | [jbd2/vdb-8]
319   be/3   root |  0.00 B/s     | 0.00 B/s      | 0.00 % | 0.02 %  | [jbd2/vda1-8]
420   be/4   root |  0.00 B/s     | 19.11 K/s     | 0.00 % | 0.00 %  | java -Xms1024m -Xmx1024m -server
```

常用示例:

```shell
# 每两秒钟进行一次统计，共统计5次，只输出进行IO的进程
iotop -n 5 -d 2 -oP
# 非交互式统计信息
iotop -d 2 -oP -b
```

#### pidstat

本文章内，此命令我们只关注-d参数的输出结果

```shell
# 监听PID为 19693的进程，每2秒钟输出一次信息，共输出5次信息
pidstat -d -p 19693 2 5
```

```
03:25:56 PM       PID   kB_rd/s   kB_wr/s kB_ccwr/s  Command
03:25:58 PM     19693      0.00   1692.00     10.00  java
03:26:00 PM     19693      0.00   3072.00     28.00  java
03:26:02 PM     19693      0.00   1562.00      0.00  java
03:26:04 PM     19693      0.00   1878.00      0.00  java
03:26:06 PM     19693      0.00   2566.00     82.00  java
Average:        19693      0.00   2154.00     24.00  java
```

kB_rd/s:每秒钟写入磁盘的数据量-单位KB    
kB_wr/s:每秒钟从磁盘读取的数据量-单位KB    
kB_ccwr/s: 每秒钟被取消写入到磁盘的数据量-单位KB    
Command: 对应的命令    


